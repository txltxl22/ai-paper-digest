<!-- Sidebar Paper Submission Component -->

<!-- Desktop Sidebar (starts collapsed) -->
<aside class="sidebar-submission collapsed" id="sidebar-submission">
  <div class="sidebar-header">
    <span class="sidebar-icon">ğŸ“„</span>
    <h3 class="sidebar-title">æäº¤è®ºæ–‡</h3>
    <button class="sidebar-collapse-btn" id="sidebar-collapse-btn" title="æ”¶èµ·ä¾§è¾¹æ ">
      <span class="collapse-icon">â†’</span>
    </button>
  </div>
  
  <div class="sidebar-content">
    {% if uid %}
      <!-- Compact Quota Display -->
      <div class="sidebar-quota">
        <div class="quota-mini">
          <span class="quota-mini-label">ä»Šæ—¥å‰©ä½™</span>
          <span class="quota-mini-value" id="sidebar-remaining">...</span>
        </div>
      </div>
      
      <!-- Compact Form -->
      <form id="sidebar-paper-form" class="sidebar-form">
        <div class="sidebar-input-group">
          <input 
            type="url" 
            id="sidebar-paper-url" 
            name="paper_url" 
            placeholder="ç²˜è´´è®ºæ–‡URL..." 
            required
            class="sidebar-input"
          />
          <button type="submit" class="sidebar-submit-btn" title="æäº¤å¤„ç†">
            <span class="submit-icon">ğŸš€</span>
          </button>
        </div>
        <div class="sidebar-hints">
          <span class="hint-item">æ”¯æŒ arXivã€HuggingFace</span>
          <span class="hint-sep">Â·</span>
          <span class="hint-item">é™{{ max_pdf_size_mb or 20 }}MB</span>
        </div>
      </form>
      
      <!-- Processing Status -->
      <div id="sidebar-status" class="sidebar-status" style="display: none;">
        <div class="status-mini-header">
          <span class="status-spinner">â³</span>
          <span class="status-mini-text" id="sidebar-step">å¤„ç†ä¸­...</span>
        </div>
        <div class="progress-mini">
          <div class="progress-mini-fill" id="sidebar-progress"></div>
        </div>
      </div>
    {% else %}
      <!-- Login Required -->
      <div class="sidebar-login-prompt">
        <span class="login-prompt-icon">ğŸ”</span>
        <p class="login-prompt-text">ç™»å½•åå¯æäº¤è®ºæ–‡</p>
      </div>
    {% endif %}
  </div>
</aside>

<!-- Sidebar Expand Button (when collapsed) -->
<button class="sidebar-expand-btn" id="sidebar-expand-btn" title="å±•å¼€æäº¤è®ºæ–‡">
  <span class="expand-btn-icon">ğŸ“„</span>
  <span class="expand-btn-text">æäº¤</span>
</button>

<!-- Mobile Floating Action Button -->
<button class="fab-submission" id="fab-submission" title="æäº¤æ–°è®ºæ–‡">
  <span class="fab-icon">ğŸ“„</span>
  <span class="fab-badge" id="fab-badge" style="display: none;"></span>
</button>

<!-- Mobile Submission Modal -->
<div class="mobile-submission-overlay" id="mobile-submission-overlay">
  <div class="mobile-submission-panel">
    <div class="mobile-submission-header">
      <h3 class="mobile-submission-title">ğŸ“„ æäº¤æ–°è®ºæ–‡</h3>
      <button class="mobile-submission-close" id="mobile-submission-close">âœ•</button>
    </div>
    
    <div class="mobile-submission-content">
      {% if uid %}
        <!-- Quota -->
        <div class="mobile-quota">
          <div class="mobile-quota-item">
            <span class="mobile-quota-label">ä»Šæ—¥å‰©ä½™</span>
            <span class="mobile-quota-value" id="mobile-remaining">...</span>
          </div>
          <div class="mobile-quota-item">
            <span class="mobile-quota-label">é‡ç½®æ—¶é—´</span>
            <span class="mobile-quota-value" id="mobile-reset-time">...</span>
          </div>
        </div>
        
        <!-- Form -->
        <form id="mobile-paper-form" class="mobile-submission-form">
          <input 
            type="url" 
            id="mobile-paper-url" 
            name="paper_url" 
            placeholder="è¾“å…¥è®ºæ–‡URL (arXivã€HuggingFaceç­‰)" 
            required
            class="mobile-url-input"
          />
          <button type="submit" class="mobile-submit-btn">
            <span class="btn-icon">ğŸš€</span>
            <span class="btn-text">æäº¤å¤„ç†</span>
          </button>
          <p class="mobile-form-hint">ä»…é™AIç›¸å…³è®ºæ–‡ï¼Œæ–‡ä»¶é™åˆ¶ {{ max_pdf_size_mb or 20 }}MB</p>
        </form>
        
        <!-- Status -->
        <div id="mobile-status" class="mobile-status" style="display: none;">
          <div class="mobile-status-header">
            <span class="status-icon">â³</span>
            <span class="status-text" id="mobile-step">å¤„ç†ä¸­...</span>
          </div>
          <div class="mobile-progress">
            <div class="mobile-progress-fill" id="mobile-progress"></div>
          </div>
          <p class="mobile-progress-text" id="mobile-progress-text">0%</p>
        </div>
      {% else %}
        <div class="mobile-login-required">
          <span class="login-icon-large">ğŸ”</span>
          <h4>éœ€è¦ç™»å½•</h4>
          <p>è¯·å…ˆç™»å½•åå†æäº¤è®ºæ–‡</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
(function() {
  // Sidebar toggle functionality
  const sidebar = document.getElementById('sidebar-submission');
  const collapseBtn = document.getElementById('sidebar-collapse-btn');
  const expandBtn = document.getElementById('sidebar-expand-btn');
  
  if (collapseBtn && sidebar && expandBtn) {
    // Sidebar starts collapsed - show expand button
    if (sidebar.classList.contains('collapsed')) {
      expandBtn.style.display = 'flex';
    }
    
    collapseBtn.addEventListener('click', function() {
      sidebar.classList.add('collapsed');
      expandBtn.style.display = 'flex';
    });
    
    expandBtn.addEventListener('click', function() {
      sidebar.classList.remove('collapsed');
      expandBtn.style.display = 'none';
    });
  }
  
  // Mobile FAB and modal
  const fab = document.getElementById('fab-submission');
  const overlay = document.getElementById('mobile-submission-overlay');
  const closeBtn = document.getElementById('mobile-submission-close');
  
  if (fab && overlay) {
    fab.addEventListener('click', function() {
      overlay.classList.add('active');
      document.body.style.overflow = 'hidden';
    });
    
    if (closeBtn) {
      closeBtn.addEventListener('click', function() {
        overlay.classList.remove('active');
        document.body.style.overflow = '';
      });
    }
    
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) {
        overlay.classList.remove('active');
        document.body.style.overflow = '';
      }
    });
  }
  
  // Form submission handlers (delegate to main paper-submission.js)
  const sidebarForm = document.getElementById('sidebar-paper-form');
  const mobileForm = document.getElementById('mobile-paper-form');
  
  function handleFormSubmit(form, urlInput, statusEl, progressEl, stepEl) {
    if (!form || !urlInput) return;
    
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      const url = urlInput.value.trim();
      if (!url) return;
      
      // Delegate to the main submission handler if available
      if (window.paperSubmissionHandler) {
        window.paperSubmissionHandler.submitPaper(url, {
          statusEl: statusEl,
          progressEl: progressEl,
          stepEl: stepEl
        });
      } else {
        // Fallback: direct API call
        try {
          if (statusEl) statusEl.style.display = 'block';
          const response = await fetch('/paper/submit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: url })
          });
          const data = await response.json();
          if (data.error) {
            alert('æäº¤å¤±è´¥: ' + data.error);
          } else {
            alert('æäº¤æˆåŠŸï¼');
            urlInput.value = '';
          }
        } catch (err) {
          alert('æäº¤å¤±è´¥: ' + err.message);
        } finally {
          if (statusEl) statusEl.style.display = 'none';
        }
      }
    });
  }
  
  handleFormSubmit(
    sidebarForm,
    document.getElementById('sidebar-paper-url'),
    document.getElementById('sidebar-status'),
    document.getElementById('sidebar-progress'),
    document.getElementById('sidebar-step')
  );
  
  handleFormSubmit(
    mobileForm,
    document.getElementById('mobile-paper-url'),
    document.getElementById('mobile-status'),
    document.getElementById('mobile-progress'),
    document.getElementById('mobile-step')
  );
  
  // Sync quota values from main form
  function syncQuota() {
    const mainRemaining = document.getElementById('remaining-uploads');
    const mainResetTime = document.getElementById('reset-time');
    const sidebarRemaining = document.getElementById('sidebar-remaining');
    const mobileRemaining = document.getElementById('mobile-remaining');
    const mobileResetTime = document.getElementById('mobile-reset-time');
    
    if (mainRemaining) {
      const value = mainRemaining.textContent;
      if (sidebarRemaining) sidebarRemaining.textContent = value;
      if (mobileRemaining) mobileRemaining.textContent = value;
    }
    
    if (mainResetTime && mobileResetTime) {
      mobileResetTime.textContent = mainResetTime.textContent;
    }
  }
  
  // Run sync periodically
  setInterval(syncQuota, 1000);
  setTimeout(syncQuota, 500);
})();
</script>

