<!doctype html>
<html lang='en'>

<head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width,initial-scale=1'>
    
    {% if rybbit_site_id %}
    <script src="https://app.rybbit.io/api/script.js" data-site-id="{{ rybbit_site_id }}" defer></script>
    {% endif %}
    
    <!-- Dynamic Title -->
    <title>{% if english_title %}{{ english_title }}{% else %}{{ arxiv_id }}{% endif %} â€“ AI Paper Summary</title>
    
    <!-- Primary Meta Tags -->
    <meta name="title" content="{% if english_title %}{{ english_title }}{% else %}{{ arxiv_id }}{% endif %} â€“ AI Paper Summary">
    <meta name="description" content="{% if abstract %}{{ abstract[:200] }}{% elif one_sentence_summary %}{{ one_sentence_summary[:200] }}{% else %}AI research paper summary and analysis for {{ arxiv_id }}{% endif %}">
    <meta name="keywords" content="{% if top_tags %}{{ top_tags|join(', ') }}{% endif %}{% if detail_tags %}, {{ detail_tags|join(', ') }}{% endif %}, AI research, machine learning, arXiv paper, {{ arxiv_id }}">
    <meta name="author" content="AI Papers Reader">
    <meta name="robots" content="index, follow">
    <meta name="article:published_time" content="{{ created_at if created_at else '' }}">
    <meta name="article:section" content="AI Research">
    {% if top_tags %}
    <meta name="article:tag" content="{{ top_tags|join(', ') }}">
    {% endif %}
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="article">
    <meta property="og:url" content="{{ request.url }}">
    <meta property="og:title" content="{% if english_title %}{{ english_title }}{% else %}{{ arxiv_id }}{% endif %}">
    <meta property="og:description" content="{% if abstract %}{{ abstract[:300] }}{% elif one_sentence_summary %}{{ one_sentence_summary[:300] }}{% else %}AI research paper summary and analysis{% endif %}">
    <meta property="og:image" content="https://arxiv.org/pdf/{{ arxiv_id }}.pdf">
    <meta property="og:site_name" content="AI Papers Reader">
    <meta property="article:published_time" content="{{ created_at if created_at else '' }}">
    {% if top_tags %}
    {% for tag in top_tags %}
    <meta property="article:tag" content="{{ tag }}">
    {% endfor %}
    {% endif %}
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="{{ request.url }}">
    <meta property="twitter:title" content="{% if english_title %}{{ english_title }}{% else %}{{ arxiv_id }}{% endif %}">
    <meta property="twitter:description" content="{% if abstract %}{{ abstract[:200] }}{% elif one_sentence_summary %}{{ one_sentence_summary[:200] }}{% else %}AI research paper summary{% endif %}">
    <meta property="twitter:image" content="https://arxiv.org/pdf/{{ arxiv_id }}.pdf">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="{{ request.url }}">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="AI Papers">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="{{ base_css_versioned() }}">
    <link rel="stylesheet" href="{{ static_css_versioned('badges.css') }}">
    <link rel="stylesheet" href="{{ static_css_versioned('components.css') }}">
    <link rel="stylesheet" href="{{ static_css_versioned('modal.css') }}">
    <link rel="icon" href="{{ url_for('static_favicon_svg') }}?v=2" type="image/svg+xml">
    
    <!-- Structured Data - ScholarlyArticle -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "ScholarlyArticle",
      "headline": "{% if english_title %}{{ english_title }}{% else %}{{ arxiv_id }}{% endif %}",
      "description": "{% if abstract %}{{ abstract[:500] }}{% elif one_sentence_summary %}{{ one_sentence_summary[:500] }}{% else %}AI research paper summary and analysis{% endif %}",
      "identifier": "{{ arxiv_id }}",
      "url": "{{ request.url }}",
      "sameAs": "https://arxiv.org/abs/{{ arxiv_id }}",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "{{ request.url }}"
      },
      "publisher": {
        "@type": "Organization",
        "name": "AI Papers Reader",
        "url": "{{ request.url_root }}"
      },
      "datePublished": "{{ created_at if created_at else '' }}",
      "dateModified": "{{ updated_at if updated_at else (created_at if created_at else '') }}",
      "inLanguage": ["en", "zh"],
      "keywords": "{% if top_tags %}{{ top_tags|join(', ') }}{% endif %}{% if detail_tags %}, {{ detail_tags|join(', ') }}{% endif %}",
      "about": [
        {% if top_tags %}
        {% for tag in top_tags %}"{{ tag }}"{% if not loop.last %},{% endif %}{% endfor %}
        {% endif %}
      ],
      "mentions": [
        {
          "@type": "Thing",
          "name": "arXiv",
          "url": "https://arxiv.org"
        }
      ]
    }
    </script>
    
    <!-- Structured Data - BreadcrumbList -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Home",
          "item": "{{ request.url_root }}"
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": "{% if english_title %}{{ english_title[:50] }}{% else %}{{ arxiv_id }}{% endif %}",
          "item": "{{ request.url }}"
        }
      ]
    }
    </script>
</head>

<body>
    {% set show_back_link = true %}
    {% include 'components/header.html' %}
    <main data-id="{{ arxiv_id }}">
        <div class="summary-header">
          <div class="source-info">
            {% if source_type == "user" %}
              <span class="user-chip" title="ç”¨æˆ·ä¸Šä¼ ">ğŸ‘¤ {{ user_id or "ç”¨æˆ·" }}</span>
              {% if original_url %}
                <span class="muted">æ¥æº: <a href="{{ original_url }}" target="_blank" class="source-link">{{ original_url }}</a></span>
              {% endif %}
            {% else %}
              <span class="user-chip" title="ç³»ç»Ÿè‡ªåŠ¨å¤„ç†">ğŸ¤– ç³»ç»Ÿ</span>
            {% endif %}
          </div>
        </div>
        
        <!-- Abstract Section -->
        {% if abstract %}
        <div class="abstract-section">
          <div class="abstract-heading">
            <span class="abstract-icon">ğŸ“„</span>
            <span>Abstract{% if english_title %} - {{ english_title }}{% endif %}</span>
          </div>
          <p class="abstract-text">{{ abstract }}</p>
        </div>
        {% else %}
        <div class="abstract-section">
          <div class="abstract-heading">
            <span class="abstract-icon">ğŸ“„</span>
            <span>Abstract{% if english_title %} - {{ english_title }}{% endif %}</span>
          </div>
          <div class="abstract-loading">
            <span class="abstract-loading-icon">â³</span>
            <span>æ­£åœ¨è·å–æ‘˜è¦...</span>
          </div>
          <button class="abstract-fetch-btn" onclick="fetchAbstract('{{ arxiv_id }}')">
            <span>ğŸ“„</span>
            <span>è·å–æ‘˜è¦</span>
          </button>
        </div>
        {% endif %}
        
        {% if top_tags and top_tags|length %}
        <div class="tag-row" style="margin: .2rem 0 .5rem;">
          <span class="muted" style="margin-right: .5rem;">é¡¶çº§æ ‡ç­¾:</span>
          {% for tg in top_tags %}
            <a class="top-chip pill" href='{{ url_for("index_page.index") }}?top={{ tg }}'>{{ tg }}</a>
          {% endfor %}
        </div>
        {% endif %}
        {% if detail_tags and detail_tags|length %}
        <form class="tag-row" method="GET" action="{{ url_for('index_page.index') }}" style="margin: .2rem 0 1rem; align-items:center; gap:.35rem;">
          <span class="muted" style="margin-right: .5rem;">è¯¦ç»†æ ‡ç­¾:</span>
          {% for tg in detail_tags %}
            <a class="tag-chip" href='{{ url_for("index_page.index") }}?tag={{ tg }}'>{{ tg }}</a>
          {% endfor %}
          <span class="muted" style="margin:0 .25rem 0 .5rem;">æˆ– æœç´¢:</span>
          <input type="text" name="q" placeholder="æ¨¡ç³Šæœç´¢æ ‡ç­¾" class="tag-input" />
          <button type="submit" class="topbar-btn">ç­›é€‰</button>
        </form>
        {% endif %}
        
        <!-- Deep Read Control Section -->
        <div class="deep-read-control" style="text-align:center; padding: var(--spacing-2xl) 0; display: none;" id="deep-read-control-container">
            <div class="deep-read-card" style="background: var(--card-bg); border: 1px solid var(--btn-border); border-radius: var(--radius-md); padding: var(--spacing-xl); max-width: 600px; margin: 0 auto;">
                <h3 style="margin-top: 0;">ğŸ¤– AI æ·±åº¦é˜…è¯»</h3>
                
                <!-- Case 1: Generate (Abstract Only) -->
                <div id="deep-read-generate-ui" style="display: none;">
                    <p style="color: var(--muted-text);">å½“å‰ä»…æ˜¾ç¤ºæ‘˜è¦æ€»ç»“ã€‚å¦‚éœ€è·å–è¯¦ç»†çš„è®ºæ–‡æ·±åº¦è§£è¯»ï¼ˆåŒ…å«åˆ›æ–°ç‚¹ã€å®éªŒç»“æœã€æœ¯è¯­è§£é‡Šç­‰ï¼‰ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ã€‚</p>
                    
                    {% if current_user_id %}
                    <button id="deep-read-gen-btn" class="primary-btn" style="font-size: 1.1rem; padding: var(--spacing-lg) var(--spacing-xl); margin-top: var(--spacing-lg);">
                        <span>ğŸ“š</span> ç”Ÿæˆæ·±åº¦è§£è¯»
                    </button>
                    <div id="deep-read-loading" style="display: none; margin-top: var(--spacing-lg);">
                        <div class="loading-spinner" style="display: inline-block; margin-right: var(--spacing-sm);"></div>
                        <span>AIæ­£åœ¨æ·±å…¥é˜…è¯»å¹¶ç”Ÿæˆè¯¦ç»†æŠ¥å‘Šï¼Œè¯·ç¨å€™... (çº¦30-60ç§’)</span>
                    </div>
                    <div id="deep-read-error" style="display: none; margin-top: var(--spacing-lg); color: var(--danger);"></div>
                    {% else %}
                    <div style="margin-top: var(--spacing-lg);">
                        <a href="/#login" class="login-cta-btn" style="display: inline-block; text-decoration: none;">
                            <span class="cta-icon">ğŸ”‘</span>
                            <span class="cta-text">ç™»å½•ä»¥å¯ç”¨æ·±åº¦é˜…è¯»</span>
                        </a>
                    </div>
                    {% endif %}
                </div>

            </div>
        </div>

        <article class='markdown-body'>
            {{ content | safe }}
        </article>
        
        <!-- Action Buttons Section -->
        <div class="card-actions" style="margin: 2rem 0 1.5rem 0; padding: 1.5rem 0; border-top: 1px solid var(--divider); border-bottom: 1px solid var(--divider);">
            <div class="primary-actions" style="display: flex; gap: 0.75rem; flex-wrap: wrap; justify-content: center;">
                {% if is_read %}
                    <a class='remove-read-link action-btn secondary-btn'>ä»æ²¡å…´è¶£åˆ—è¡¨ç§»é™¤</a>
                {% else %}
                    {% if uid %}
                        <a class='mark-read-link action-btn secondary-btn'>ğŸ‘‹ æ²¡å…´è¶£</a>
                    {% else %}
                        <a class='mark-read-link action-btn secondary-btn disabled'>ğŸ‘‹ æ²¡å…´è¶£</a>
                    {% endif %}
                {% endif %}
                {% if uid %}
                    <a class='favorite-link action-btn secondary-btn' data-favorited='{{ 'true' if is_favorited else 'false' }}'>
                        {% if is_favorited %}â­ å–æ¶ˆæ„Ÿå…´è¶£{% else %}â˜† æ„Ÿå…´è¶£{% endif %}
                    </a>
                {% else %}
                    <a class='favorite-link action-btn secondary-btn disabled'>â˜† æ„Ÿå…´è¶£</a>
                {% endif %}
                {% if uid %}
                    <a class='add-todo-link action-btn secondary-btn'>ğŸ“Œ å¾…è¯»</a>
                {% else %}
                    <a class='add-todo-link action-btn secondary-btn disabled'>ğŸ“Œ å¾…è¯»</a>
                {% endif %}
            </div>
        </div>
        
        <p style='text-align:center;margin-top:var(--spacing-2xl);'>
            <a id='pdf-link' target='_blank' href='https://arxiv.org/pdf/{{ arxiv_id }}.pdf'>ğŸ“„ æ‰“å¼€åŸæ–‡ PDF</a>
        </p>
    </main>
    
    {% include 'components/admin-modal.html' %}
    <!-- JavaScript Modules -->
    <script src="{{ url_for('static_js', filename='event-tracker.js') }}"></script>
    <script src="{{ url_for('static_js', filename='theme.js') }}"></script>
    <script src="{{ url_for('static_js', filename='toast.js') }}"></script>
    <script src="{{ url_for('static_js', filename='user-actions.js') }}"></script>
    <script src="{{ url_for('static_js', filename='article-actions.js') }}"></script>
    <script src="{{ url_for('static_js', filename='admin-modal.js') }}"></script>
    <script src="{{ url_for('static_js', filename='paper-submission.js') }}"></script>
    <script src="{{ url_for('static_js', filename='visitor-stats-tracker.js') }}"></script>
    <script src="{{ url_for('static_js', filename='abstract-viewer.js') }}"></script>
    <script src="{{ url_for('static_js', filename='deep-read-status.js') }}"></script>
    
    <script>
      // URL configuration for Flask templates
      window.appUrls = {
        mark_read: '{{ mark_read_url }}',
        unmark_read: '{{ unmark_read_url }}',
        mark_favorite: '{{ mark_favorite_url }}',
        unmark_favorite: '{{ unmark_favorite_url }}',
        mark_todo: '{{ mark_todo_url }}',
        unmark_todo: '{{ unmark_todo_url }}',
        reset: '{{ reset_url }}',
        admin_stream: '{{ admin_stream_url }}',
        admin_fetch: '{{ admin_fetch_url }}'
      };
      
      // PDF click event for detail page - using centralized event tracker
      document.getElementById('pdf-link')?.addEventListener('click', (ev) => {
        const href = ev.currentTarget.getAttribute('href');
        window.eventTracker.track('open_pdf', '{{ arxiv_id }}', { href });
      });
      
      // Service Worker Registration for PWA
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/service-worker.js')
            .then((registration) => {
              console.log('Service Worker registered:', registration.scope);
            })
            .catch((error) => {
              console.log('Service Worker registration failed:', error);
            });
        });
      }
      
      // Abstract fetching function for detail page
      async function fetchAbstract(arxivId) {
        const abstractSection = document.querySelector('.abstract-section');
        if (!abstractSection) return;
        
        const loadingDiv = abstractSection.querySelector('.abstract-loading');
        const fetchBtn = abstractSection.querySelector('.abstract-fetch-btn');
        
        if (loadingDiv) loadingDiv.style.display = 'flex';
        if (fetchBtn) fetchBtn.style.display = 'none';
        
        try {
          const response = await fetch(`/api/abstract/${arxivId}`);
          const data = await response.json();
          
          if (response.ok && data.abstract) {
            // Replace the loading section with the abstract
            abstractSection.innerHTML = `
              <div class="abstract-heading">
                <span class="abstract-icon">ğŸ“„</span>
                <span>åŸå§‹æ‘˜è¦</span>
              </div>
              <p class="abstract-text">${data.abstract}</p>
            `;
          } else {
            // Show error message
            abstractSection.innerHTML = `
              <div class="abstract-heading">
                <span class="abstract-icon">ğŸ“„</span>
                <span>åŸå§‹æ‘˜è¦</span>
              </div>
              <div class="abstract-error">
                <p>æ— æ³•è·å–æ‘˜è¦: ${data.message || 'æœªçŸ¥é”™è¯¯'}</p>
                <button class="abstract-fetch-btn" onclick="fetchAbstract('${arxivId}')">
                  <span>ğŸ”„</span>
                  <span>é‡è¯•</span>
                </button>
              </div>
            `;
          }
        } catch (error) {
          console.error('Error fetching abstract:', error);
          abstractSection.innerHTML = `
            <div class="abstract-heading">
              <span class="abstract-icon">ğŸ“„</span>
              <span>åŸå§‹æ‘˜è¦</span>
            </div>
            <div class="abstract-error">
              <p>ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•è·å–æ‘˜è¦</p>
              <button class="abstract-fetch-btn" onclick="fetchAbstract('${arxivId}')">
                <span>ğŸ”„</span>
                <span>é‡è¯•</span>
              </button>
            </div>
          `;
        }
      }

      // Deep Read handling - only show section for abstract-only summaries
      const isAbstractOnly = '{{ is_abstract_only | string | lower }}' === 'true';
      
      if (isAbstractOnly) {
        const controlContainer = document.getElementById('deep-read-control-container');
        const generateUI = document.getElementById('deep-read-generate-ui');
        controlContainer.style.display = 'block';
        generateUI.style.display = 'block';
      }
      // If complete summary exists, it's shown directly (no section needed)

      // Generate Button Logic
      const deepReadGenBtn = document.getElementById('deep-read-gen-btn');
      if (deepReadGenBtn) {
        deepReadGenBtn.addEventListener('click', async () => {
          const loading = document.getElementById('deep-read-loading');
          const error = document.getElementById('deep-read-error');
          
          deepReadGenBtn.style.display = 'none';
          loading.style.display = 'block';
          error.style.display = 'none';
          
          try {
            const response = await fetch('{{ deep_read_url }}', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              }
            });
            
            // Try to parse JSON, but handle failures gracefully
            let data = {};
            try {
              data = await response.json();
            } catch (jsonError) {
              console.warn('Failed to parse response as JSON:', jsonError);
              // If response is OK but JSON parsing failed, treat as success
              // (the backend might have returned empty body)
              if (response.ok) {
                data = { success: true, processing: true };
              }
            }
            
            if (response.ok && data.success) {
              if (data.processing || data.already_processing) {
                // Processing started, show status bar and keep loading
                showToast('æ·±åº¦é˜…è¯»ç”Ÿæˆå·²å¼€å§‹ï¼Œè¯·ç¨å€™');
                if (window.deepReadStatusBar) {
                  // Register this job so we can detect when it completes
                  window.deepReadStatusBar.registerProcessingJob('{{ arxiv_id }}');
                  window.deepReadStatusBar.updateStatus().then(() => {
                    // Start polling to track the new job
                    window.deepReadStatusBar.startPolling();
                  });
                }
                // Don't reload yet - status bar will show progress
                // Page will auto-refresh when deep read completes
              } else {
                // Shouldn't happen with new async flow, but keep as fallback
                window.location.reload();
              }
            } else if (response.ok) {
              // Response OK but success not explicitly true - still treat as processing started
              showToast('æ·±åº¦é˜…è¯»ç”Ÿæˆå·²å¼€å§‹ï¼Œè¯·ç¨å€™');
              if (window.deepReadStatusBar) {
                window.deepReadStatusBar.registerProcessingJob('{{ arxiv_id }}');
                window.deepReadStatusBar.updateStatus().then(() => {
                  window.deepReadStatusBar.startPolling();
                });
              }
            } else {
              // Response not OK - show error
              loading.style.display = 'none';
              deepReadGenBtn.style.display = 'inline-block';
              error.textContent = data.message || 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
              error.style.display = 'block';
            }
          } catch (err) {
            console.error('Deep read error:', err);
            loading.style.display = 'none';
            deepReadGenBtn.style.display = 'inline-block';
            error.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
            error.style.display = 'block';
          }
        });
      }
      
    </script>

</body>

</html>