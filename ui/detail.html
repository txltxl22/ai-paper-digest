<!doctype html>
<html lang='en'>

<head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width,initial-scale=1'>
    
    <!-- Dynamic Title -->
    <title>{% if english_title %}{{ english_title }}{% else %}{{ arxiv_id }}{% endif %} â€“ AI Paper Summary</title>
    
    <!-- Primary Meta Tags -->
    <meta name="title" content="{% if english_title %}{{ english_title }}{% else %}{{ arxiv_id }}{% endif %} â€“ AI Paper Summary">
    <meta name="description" content="{% if abstract %}{{ abstract[:200] }}{% elif one_sentence_summary %}{{ one_sentence_summary[:200] }}{% else %}AI research paper summary and analysis for {{ arxiv_id }}{% endif %}">
    <meta name="keywords" content="{% if top_tags %}{{ top_tags|join(', ') }}{% endif %}{% if detail_tags %}, {{ detail_tags|join(', ') }}{% endif %}, AI research, machine learning, arXiv paper, {{ arxiv_id }}">
    <meta name="author" content="AI Papers Reader">
    <meta name="robots" content="index, follow">
    <meta name="article:published_time" content="{{ created_at if created_at else '' }}">
    <meta name="article:section" content="AI Research">
    {% if top_tags %}
    <meta name="article:tag" content="{{ top_tags|join(', ') }}">
    {% endif %}
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="article">
    <meta property="og:url" content="{{ request.url }}">
    <meta property="og:title" content="{% if english_title %}{{ english_title }}{% else %}{{ arxiv_id }}{% endif %}">
    <meta property="og:description" content="{% if abstract %}{{ abstract[:300] }}{% elif one_sentence_summary %}{{ one_sentence_summary[:300] }}{% else %}AI research paper summary and analysis{% endif %}">
    <meta property="og:image" content="https://arxiv.org/pdf/{{ arxiv_id }}.pdf">
    <meta property="og:site_name" content="AI Papers Reader">
    <meta property="article:published_time" content="{{ service_data.get('created_at', '') if service_data else '' }}">
    {% if top_tags %}
    {% for tag in top_tags %}
    <meta property="article:tag" content="{{ tag }}">
    {% endfor %}
    {% endif %}
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="{{ request.url }}">
    <meta property="twitter:title" content="{% if english_title %}{{ english_title }}{% else %}{{ arxiv_id }}{% endif %}">
    <meta property="twitter:description" content="{% if abstract %}{{ abstract[:200] }}{% elif one_sentence_summary %}{{ one_sentence_summary[:200] }}{% else %}AI research paper summary{% endif %}">
    <meta property="twitter:image" content="https://arxiv.org/pdf/{{ arxiv_id }}.pdf">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="{{ request.url }}">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="AI Papers">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="{{ url_for('base_css') }}">
    <link rel="stylesheet" href="{{ url_for('static_css', filename='badges.css') }}">
    <link rel="stylesheet" href="{{ url_for('static_css', filename='components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static_css', filename='modal.css') }}">
    <link rel="icon" href="{{ url_for('static_favicon_svg') }}?v=2" type="image/svg+xml">
    
    <!-- Structured Data - ScholarlyArticle -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "ScholarlyArticle",
      "headline": "{% if english_title %}{{ english_title }}{% else %}{{ arxiv_id }}{% endif %}",
      "description": "{% if abstract %}{{ abstract[:500] }}{% elif one_sentence_summary %}{{ one_sentence_summary[:500] }}{% else %}AI research paper summary and analysis{% endif %}",
      "identifier": "{{ arxiv_id }}",
      "url": "{{ request.url }}",
      "sameAs": "https://arxiv.org/abs/{{ arxiv_id }}",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "{{ request.url }}"
      },
      "publisher": {
        "@type": "Organization",
        "name": "AI Papers Reader",
        "url": "{{ request.url_root }}"
      },
      "datePublished": "{{ created_at if created_at else '' }}",
      "dateModified": "{{ updated_at if updated_at else (created_at if created_at else '') }}",
      "inLanguage": ["en", "zh"],
      "keywords": "{% if top_tags %}{{ top_tags|join(', ') }}{% endif %}{% if detail_tags %}, {{ detail_tags|join(', ') }}{% endif %}",
      "about": [
        {% if top_tags %}
        {% for tag in top_tags %}"{{ tag }}"{% if not loop.last %},{% endif %}{% endfor %}
        {% endif %}
      ],
      "mentions": [
        {
          "@type": "Thing",
          "name": "arXiv",
          "url": "https://arxiv.org"
        }
      ]
    }
    </script>
    
    <!-- Structured Data - BreadcrumbList -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Home",
          "item": "{{ request.url_root }}"
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": "{% if english_title %}{{ english_title[:50] }}{% else %}{{ arxiv_id }}{% endif %}",
          "item": "{{ request.url }}"
        }
      ]
    }
    </script>
</head>

<body>
    {% set show_back_link = true %}
    {% include 'components/header.html' %}
    <main>
        <div class="summary-header">
          <div class="source-info">
            {% if source_type == "user" %}
              <span class="user-chip" title="ç”¨æˆ·ä¸Šä¼ ">ğŸ‘¤ {{ user_id or "ç”¨æˆ·" }}</span>
              {% if original_url %}
                <span class="muted">æ¥æº: <a href="{{ original_url }}" target="_blank" class="source-link">{{ original_url }}</a></span>
              {% endif %}
            {% else %}
              <span class="user-chip" title="ç³»ç»Ÿè‡ªåŠ¨å¤„ç†">ğŸ¤– ç³»ç»Ÿ</span>
            {% endif %}
          </div>
        </div>
        
        <!-- Abstract Section -->
        {% if abstract %}
        <div class="abstract-section">
          <div class="abstract-heading">
            <span class="abstract-icon">ğŸ“„</span>
            <span>Abstract{% if english_title %} - {{ english_title }}{% endif %}</span>
          </div>
          <p class="abstract-text">{{ abstract }}</p>
        </div>
        {% else %}
        <div class="abstract-section">
          <div class="abstract-heading">
            <span class="abstract-icon">ğŸ“„</span>
            <span>Abstract{% if english_title %} - {{ english_title }}{% endif %}</span>
          </div>
          <div class="abstract-loading">
            <span class="abstract-loading-icon">â³</span>
            <span>æ­£åœ¨è·å–æ‘˜è¦...</span>
          </div>
          <button class="abstract-fetch-btn" onclick="fetchAbstract('{{ arxiv_id }}')">
            <span>ğŸ“„</span>
            <span>è·å–æ‘˜è¦</span>
          </button>
        </div>
        {% endif %}
        
        {% if top_tags and top_tags|length %}
        <div class="tag-row" style="margin: .2rem 0 .5rem;">
          <span class="muted" style="margin-right: .5rem;">é¡¶çº§æ ‡ç­¾:</span>
          {% for tg in top_tags %}
            <a class="top-chip pill" href='{{ url_for("index_page.index") }}?top={{ tg }}'>{{ tg }}</a>
          {% endfor %}
        </div>
        {% endif %}
        {% if detail_tags and detail_tags|length %}
        <form class="tag-row" method="GET" action="{{ url_for('index_page.index') }}" style="margin: .2rem 0 1rem; align-items:center; gap:.35rem;">
          <span class="muted" style="margin-right: .5rem;">è¯¦ç»†æ ‡ç­¾:</span>
          {% for tg in detail_tags %}
            <a class="tag-chip" href='{{ url_for("index_page.index") }}?tag={{ tg }}'>{{ tg }}</a>
          {% endfor %}
          <span class="muted" style="margin:0 .25rem 0 .5rem;">æˆ– æœç´¢:</span>
          <input type="text" name="q" placeholder="æ¨¡ç³Šæœç´¢æ ‡ç­¾" class="tag-input" />
          <button type="submit" class="topbar-btn">ç­›é€‰</button>
        </form>
        {% endif %}
        <article class='markdown-body'>
            {{ content | safe }}
        </article>
        <p style='text-align:center;margin-top:2rem;'>
            <a id='pdf-link' target='_blank' href='https://arxiv.org/pdf/{{ arxiv_id }}.pdf'>ğŸ“„ æ‰“å¼€åŸæ–‡ PDF</a>
        </p>
    </main>
    
    {% include 'components/admin-modal.html' %}
    <!-- JavaScript Modules -->
    <script src="{{ url_for('static_js', filename='event-tracker.js') }}"></script>
    <script src="{{ url_for('static_js', filename='theme.js') }}"></script>
    <script src="{{ url_for('static_js', filename='toast.js') }}"></script>
    <script src="{{ url_for('static_js', filename='user-actions.js') }}"></script>
    <script src="{{ url_for('static_js', filename='article-actions.js') }}"></script>
    <script src="{{ url_for('static_js', filename='admin-modal.js') }}"></script>
    <script src="{{ url_for('static_js', filename='paper-submission.js') }}"></script>
    <script src="{{ url_for('static_js', filename='visitor-stats-tracker.js') }}"></script>
    <script src="{{ url_for('static_js', filename='abstract-viewer.js') }}"></script>
    
    <script>
      // URL configuration for Flask templates
      window.appUrls = {
        mark_read: '{{ mark_read_url }}',
        unmark_read: '{{ unmark_read_url }}',
        reset: '{{ reset_url }}',
        admin_stream: '{{ admin_stream_url }}',
        admin_fetch: '{{ admin_fetch_url }}'
      };
      
      // PDF click event for detail page - using centralized event tracker
      document.getElementById('pdf-link')?.addEventListener('click', (ev) => {
        const href = ev.currentTarget.getAttribute('href');
        window.eventTracker.track('open_pdf', '{{ arxiv_id }}', { href });
      });
      
      // Service Worker Registration for PWA
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/service-worker.js')
            .then((registration) => {
              console.log('Service Worker registered:', registration.scope);
            })
            .catch((error) => {
              console.log('Service Worker registration failed:', error);
            });
        });
      }
      
      // Abstract fetching function for detail page
      async function fetchAbstract(arxivId) {
        const abstractSection = document.querySelector('.abstract-section');
        if (!abstractSection) return;
        
        const loadingDiv = abstractSection.querySelector('.abstract-loading');
        const fetchBtn = abstractSection.querySelector('.abstract-fetch-btn');
        
        if (loadingDiv) loadingDiv.style.display = 'flex';
        if (fetchBtn) fetchBtn.style.display = 'none';
        
        try {
          const response = await fetch(`/api/abstract/${arxivId}`);
          const data = await response.json();
          
          if (response.ok && data.abstract) {
            // Replace the loading section with the abstract
            abstractSection.innerHTML = `
              <div class="abstract-heading">
                <span class="abstract-icon">ğŸ“„</span>
                <span>åŸå§‹æ‘˜è¦</span>
              </div>
              <p class="abstract-text">${data.abstract}</p>
            `;
          } else {
            // Show error message
            abstractSection.innerHTML = `
              <div class="abstract-heading">
                <span class="abstract-icon">ğŸ“„</span>
                <span>åŸå§‹æ‘˜è¦</span>
              </div>
              <div class="abstract-error">
                <p>æ— æ³•è·å–æ‘˜è¦: ${data.message || 'æœªçŸ¥é”™è¯¯'}</p>
                <button class="abstract-fetch-btn" onclick="fetchAbstract('${arxivId}')">
                  <span>ğŸ”„</span>
                  <span>é‡è¯•</span>
                </button>
              </div>
            `;
          }
        } catch (error) {
          console.error('Error fetching abstract:', error);
          abstractSection.innerHTML = `
            <div class="abstract-heading">
              <span class="abstract-icon">ğŸ“„</span>
              <span>åŸå§‹æ‘˜è¦</span>
            </div>
            <div class="abstract-error">
              <p>ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•è·å–æ‘˜è¦</p>
              <button class="abstract-fetch-btn" onclick="fetchAbstract('${arxivId}')">
                <span>ğŸ”„</span>
                <span>é‡è¯•</span>
              </button>
            </div>
          `;
        }
      }
    </script>

</body>

</html>